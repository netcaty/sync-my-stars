name: Sync Starred Repos to Codeberg

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      full_sync:
        description: '强制完整同步（跳过增量检查）'
        required: false
        default: false
        type: boolean

# 设置工作流权限（关键修改！）
permissions:
  contents: write  # 允许提交状态文件
  actions: write   # 允许写入工作流

jobs:
  sync-repos:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository with full history
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史，以便访问之前的提交
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Run sync script
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT  }}
        CODEBERG_USERNAME: ${{ secrets.CODEBERG_USERNAME }}
        CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        FULL_SYNC: ${{ inputs.full_sync }}
      run: |
        python -m pip install --upgrade pip
        pip install requests
        python .github/scripts/sync-starred-to-codeberg.py || true
    
    - name: Commit and push state file if changed
      run: |
        if [[ -n "$(git status --porcelain .github/sync_state.json)" ]]; then
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .github/sync_state.json
          git commit -m "Update sync state $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin HEAD:${{ github.ref_name }}
        else
          echo "状态文件未更改，跳过提交"
        fi